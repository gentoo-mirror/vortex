From 9350d9a19e4df9a00151bd4a2321fabf86ad947d Mon Sep 17 00:00:00 2001
From: Yuri Konotopov <ykonotopov@gnome.org>
Date: Sat, 20 May 2017 00:26:45 +0400
Subject: [PATCH] Make build system Gentoo-compatible

---
 CMakeLists.txt              | 36 ++++++++++++++++++------------------
 driver/video/CMakeLists.txt |  8 ++++++--
 2 files changed, 24 insertions(+), 20 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 3c9ddbb..bc4a826 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -148,6 +148,17 @@ ELSE()
 ENDIF()
 UNSET(TMP_BOOST_VERSION)
 
+################################################################################
+# Drivers options
+
+OPTION(BUILD_GLFW_DRIVER "Build the GLFW video driver" 0)
+OPTION(BUILD_SDL_DRIVER "Build the sdl video driver" 1)
+IF (UNIX)
+       IF (NOT BUILD_SDL_DRIVER AND NOT BUILD_GLFW_DRIVER)
+               MESSAGE(FATAL_ERROR "No video driver selected! Either use SDL or GLFW.")
+       ENDIF (NOT BUILD_SDL_DRIVER AND NOT BUILD_GLFW_DRIVER)
+ENDIF (UNIX)
+
 ################################################################################
 # Set paths
 # All paths are relative to the install-prefix.
@@ -188,7 +199,7 @@ ELSE()
 	SET(RTTR_DRIVERDIR "${DEFAULT_DRIVERDIR}" CACHE STRING "Directory for driver objects")
 ENDIF()
 # Ensure relative paths
-foreach(curDirVar RTTR_BINDIR RTTR_DATADIR RTTR_GAMEDIR RTTR_LIBDIR RTTR_DOCDIR RTTR_DRIVERDIR)
+foreach(curDirVar RTTR_BINDIR RTTR_DATADIR RTTR_LIBDIR RTTR_DOCDIR RTTR_DRIVERDIR)
 	if(IS_ABSOLUTE ${${curDirVar}})
 		message(FATAL_ERROR "All RTTR_*DIR variables must be relative paths. ${curDirVar} is absolute: ${${curDirVar}}")
 	endif()
@@ -330,22 +341,12 @@ MACRO(symlinkFolder dst symLinkPath)
 	ENDIF()
 ENDMACRO(symlinkFolder)
 
-IF(NOT ${CMAKE_HOST_SYSTEM_NAME} MATCHES "Windows")
-	file(MAKE_DIRECTORY "${CMAKE_BINARY_DIR}/${RTTR_DATADIR}")
-	symlinkFolder("${CMAKE_SOURCE_DIR}/RTTR" "${CMAKE_BINARY_DIR}/${RTTR_DATADIR}/RTTR")
-	file(MAKE_DIRECTORY "${CMAKE_BINARY_DIR}/${RTTR_LIBDIR}/RTTR")
-	if(NOT EXISTS "${CMAKE_SOURCE_DIR}/S2")
-		file(MAKE_DIRECTORY "${CMAKE_SOURCE_DIR}/S2")
-	endif()
-	symlinkFolder("${CMAKE_SOURCE_DIR}/S2" "${CMAKE_BINARY_DIR}/${RTTR_GAMEDIR}")
-ELSE()
-	message(STATUS "Host system is ${CMAKE_HOST_SYSTEM_NAME}. Will use copies instead of symlinks")
-	file(COPY "${CMAKE_SOURCE_DIR}/RTTR" DESTINATION "${CMAKE_BINARY_DIR}"
-		 PATTERN "*.po" EXCLUDE
-		 PATTERN "*.pot" EXCLUDE
-		 PATTERN ".*" EXCLUDE
-	)
-ENDIF()
+message(STATUS "Host system is ${CMAKE_HOST_SYSTEM_NAME}. Will use copies instead of symlinks")
+file(COPY "${CMAKE_SOURCE_DIR}/RTTR" DESTINATION "${CMAKE_BINARY_DIR}"
+	 PATTERN "*.po" EXCLUDE
+	 PATTERN "*.pot" EXCLUDE
+	 PATTERN ".*" EXCLUDE
+)
 
 ################################################################################
 # Configure files
@@ -401,7 +402,6 @@ ADD_SUBDIRECTORY(libutil)
 SET(LOBBY_C TRUE)
 ADD_SUBDIRECTORY(liblobby)
 ADD_SUBDIRECTORY(s-c)
-ADD_SUBDIRECTORY(s25update)
 ADD_SUBDIRECTORY(src)
 
 ################################################################################
diff --git a/driver/video/CMakeLists.txt b/driver/video/CMakeLists.txt
index bcc8e10..f32d85b 100644
--- a/driver/video/CMakeLists.txt
+++ b/driver/video/CMakeLists.txt
@@ -1,6 +1,10 @@
 
 ADD_SUBDIRECTORY( WinAPI )
-ADD_SUBDIRECTORY( GLFW )
-ADD_SUBDIRECTORY( SDL )
+IF(BUILD_GLFW_DRIVER)
+	ADD_SUBDIRECTORY( GLFW )
+ENDIF(BUILD_GLFW_DRIVER)
+IF(BUILD_SDL_DRIVER)
+	ADD_SUBDIRECTORY( SDL )
+ENDIF(BUILD_SDL_DRIVER)
 
 #################################################################################
-- 
2.10.2

